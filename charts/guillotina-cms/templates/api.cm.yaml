apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "fullname" . }}-config
  labels:
    app: {{ template "name" . }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
data:
  config.yaml: |-
    aiohttp_settings:
      client_max_size: 20971520
    databases:
    - db:
        storage: postgresql
        transaction_strategy: dbresolve_readcommitted
        dsn: postgresql://{{ .Values.db.postgresqlUsername }}:{{ .Values.db.postgresqlPassword }}@{{ .Release.Name }}-db:5432/{{ .Values.db.postgresqlDatabase }}
        read_only: false
        pool_size: 100
    applications:
    - guillotina_cms
    - guillotina_dbusers
    - guillotina.contrib.catalog.pg
    - guillotina.contrib.cache
    - guillotina.contrib.swagger
    address: {{ .Values.api.service.internalPort }}
    static:
    - favicon.png: static/favicon.png
    - assets: guillotina:static/assets
    root_user:
      password: {{ .Values.api.root_passwd }}
    auth_extractors:
    - guillotina.auth.extractors.CookiePolicy
    - guillotina.auth.extractors.BearerAuthPolicy
    - guillotina.auth.extractors.BasicAuthPolicy
    - guillotina.auth.extractors.WSTokenAuthPolicy
    auth_token_validators:
    - guillotina.auth.validators.SaltedHashPasswordValidator
    - guillotina.auth.validators.JWTValidator
    {{- if .Values.cms.global_disallowed_types }}
    global_disallowed_types:
    {{- toYaml .Values.cms.global_disallowed_types | nindent 4 }}
    {{- end }}
    {{- if .Values.cms.layouts -}}
    layouts:
    {{- toYaml .Values.cms.layouts | nindent 6 -}}
    {{- end -}}
    {{- if .Values.cms.default_tiles -}}
    default_tiles:
    {{- toYaml .Values.cms.default_tiles | nindent 4 -}}
    {{- end -}}
    default_allow_discussion: {{ .Values.cms.default_allow_discussion }}
    jwt:
      secret: {{ .Values.api.jwtsecret }}
      algorithm: HS256
    jsapps:
      +admin: guillotina:static/executioner
    cors:
      allow_origin:
      - "*"
      - "{{ .Values.front.service.externalUrl }}"
      allow_methods:
      - GET
      - POST
      - DELETE
      - HEAD
      - PATCH
      - OPTIONS
      allow_headers:
      - "*"
      expose_headers:
      - "*"
      allow_credentials: true
      max_age: 3660
    {{- if .Values.cms.workflows }}
    workflows:
    {{- toYaml .Values.cms.workflows | nindent 6 -}}
    {{- end }}
    {{- if .Values.cms.content }}
    content:
    {{- toYaml .Values.cms.content | nindent 6 -}}
    {{- end }}
